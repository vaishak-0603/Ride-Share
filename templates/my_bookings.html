<!--
My Bookings Template for Ride-Share Application

This template displays bookings made by the current user with the following features:

1. Tabbed Interface:
   - Active Bookings
   - Past Bookings

2. Booking Cards:
   Each booking shows:
   - Route details (origin → destination)
   - Date and time
   - Driver information
   - Number of seats
   - Total price
   - Booking status
   - Contact details
   - Pickup/Drop addresses
   - Cancel option (if eligible)

3. Status Indicators:
   - Success: Confirmed bookings
   - Warning: Pending bookings
   - Danger: Cancelled bookings

Dependencies:
- Bootstrap 5 for components
- Bootstrap Icons
- Flask-Login for auth
-->

{% extends "base.html" %}

{% block title %}My Bookings - Ride-Share{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-calendar-check text-primary me-2" aria-hidden="true"></i>My Bookings
        </h1>
        <a href="{{ url_for('search_rides') }}" class="btn btn-primary">
            <i class="bi bi-search me-1" aria-hidden="true"></i>Find New Rides
        </a>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-pills mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#upcoming" type="button" role="tab">
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>Upcoming
                {% if active_bookings %}<span class="badge bg-light text-primary ms-1">{{ active_bookings|length
                    }}</span>{% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#past" type="button" role="tab">
                <i class="bi bi-clock-history me-1" aria-hidden="true"></i>Past
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#cancelled" type="button" role="tab">
                <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Cancelled
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Upcoming/Active Bookings Tab -->
        <div class="tab-pane fade show active" id="upcoming" role="tabpanel">
            {% if active_bookings %}
            <div class="list-group">
                {% for booking in active_bookings %}
                <div class="list-group-item list-group-item-action p-0 mb-2 border rounded">
                    <!-- Collapsed Header - Always Visible -->
                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer"
                        data-bs-toggle="collapse" data-bs-target="#booking-{{ booking.id }}" aria-expanded="false"
                        role="button">
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center" style="min-width: 50px;">
                                <div class="fw-bold text-primary">{{ booking.ride.start_date.strftime('%b') }}</div>
                                <div class="fs-4 fw-bold">{{ booking.ride.start_date.strftime('%d') }}</div>
                            </div>
                            <div>
                                <div class="fw-semibold">{{ booking.ride.origin }} → {{ booking.ride.destination }}
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1" aria-hidden="true"></i>{{
                                    booking.ride.start_date.strftime('%I:%M %p') }}
                                    <span class="mx-2">•</span>
                                    <i class="bi bi-person me-1" aria-hidden="true"></i>{{ booking.ride.driver.username
                                    }}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span
                                class="badge bg-{{ 'success' if booking.status == 'CONFIRMED' else 'warning text-dark' }}">
                                {{ booking.status }}
                            </span>
                            <i class="bi bi-chevron-down" aria-hidden="true"></i>
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    <div class="collapse border-top" id="booking-{{ booking.id }}">
                        <div class="p-3 bg-light">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Seats Booked</small>
                                    <span class="fw-semibold">{{ booking.seats }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Total Price</small>
                                    <span class="fw-semibold text-success">₹{{ "%.2f"|format(booking.seats *
                                        booking.ride.price_per_seat) }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Contact</small>
                                    <span>{{ booking.contact_number or 'None' }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Car</small>
                                    <span>{{ booking.ride.car.make }} {{ booking.ride.car.model }}</span>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Pickup</small>
                                    <span><i class="bi bi-geo-alt text-success me-1" aria-hidden="true"></i>{{
                                        booking.pickup_address or 'Not specified' }}</span>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Drop</small>
                                    <span><i class="bi bi-geo-alt-fill text-danger me-1" aria-hidden="true"></i>{{
                                        booking.drop_address or 'Not specified' }}</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-top d-flex gap-2 flex-wrap">
                                {% if booking.ride.status == 'ONGOING' and booking.status == 'CONFIRMED' %}
                                <form method="POST"
                                    action="{{ url_for('mark_booking_complete', booking_id=booking.id) }}"
                                    class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-check-circle me-1" aria-hidden="true"></i>Complete Ride
                                    </button>
                                </form>
                                {% endif %}
                                {% if booking.can_cancel() %}
                                <button class="btn btn-outline-danger btn-sm" onclick="cancelBooking({{ booking.id }})">
                                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Cancel Booking
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-calendar-x display-4 text-muted" aria-hidden="true"></i>
                <h3 class="h5 mt-3">No Upcoming Bookings</h3>
                <p class="text-muted">Find a ride to get started</p>
                <a href="{{ url_for('search_rides') }}" class="btn btn-primary">Find Rides</a>
            </div>
            {% endif %}
        </div>

        <!-- Past/Completed Bookings Tab -->
        <div class="tab-pane fade" id="past" role="tabpanel">
            {% set completed_bookings = past_bookings|selectattr('status', 'in', ['CONFIRMED', 'COMPLETED'])|list %}
            {% if completed_bookings %}
            <div class="list-group">
                {% for booking in completed_bookings %}
                <div class="list-group-item list-group-item-action p-0 mb-2 border rounded">
                    <!-- Collapsed Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer"
                        data-bs-toggle="collapse" data-bs-target="#past-booking-{{ booking.id }}" aria-expanded="false"
                        role="button">
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center" style="min-width: 50px;">
                                <div class="small text-muted">{{ booking.ride.start_date.strftime('%b') }}</div>
                                <div class="fs-5 fw-bold">{{ booking.ride.start_date.strftime('%d') }}</div>
                            </div>
                            <div>
                                <div class="fw-semibold">{{ booking.ride.origin }} → {{ booking.ride.destination }}
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-person me-1" aria-hidden="true"></i>{{ booking.ride.driver.username
                                    }}
                                    <span class="mx-2">•</span>
                                    {{ booking.seats }} seat(s) • ₹{{ "%.0f"|format(booking.seats *
                                    booking.ride.price_per_seat) }}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-success">Completed</span>
                            {% set existing_review = [] %}
                            {% for review in booking.ride.driver.reviews_received %}
                            {% if review.reviewer_id == current_user.id and review.booking_id == booking.id %}
                            {% set _ = existing_review.append(review) %}
                            {% endif %}
                            {% endfor %}
                            {% if existing_review %}
                            <span class="text-success small"><i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                                Reviewed</span>
                            {% endif %}
                            <i class="bi bi-chevron-down" aria-hidden="true"></i>
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    <div class="collapse border-top" id="past-booking-{{ booking.id }}">
                        <div class="p-3 bg-light">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Date & Time</small>
                                    <span>{{ booking.ride.start_date.strftime('%B %d, %Y') }}</span>
                                    <small class="d-block">{{ booking.ride.start_date.strftime('%I:%M %p') }}</small>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Total Paid</small>
                                    <span class="fw-semibold">₹{{ "%.2f"|format(booking.seats *
                                        booking.ride.price_per_seat) }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Pickup</small>
                                    <span>{{ booking.pickup_address or 'N/A' }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-muted d-block">Drop</small>
                                    <span>{{ booking.drop_address or 'N/A' }}</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-top">
                                {% if existing_review %}
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-success">
                                        <i class="bi bi-check-circle-fill me-1" aria-hidden="true"></i>Review submitted
                                    </span>
                                    {% if existing_review[0].flag_type == 'green' %}
                                    <span class="badge bg-success"><i class="bi bi-flag-fill me-1"></i>Green Flag</span>
                                    {% elif existing_review[0].flag_type == 'red' %}
                                    <span class="badge bg-danger"><i class="bi bi-flag-fill me-1"></i>Red Flag</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <a href="{{ url_for('submit_review', booking_id=booking.id) }}"
                                    class="btn btn-warning btn-sm">
                                    <i class="bi bi-flag me-1" aria-hidden="true"></i>Leave Review
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-clock-history display-4 text-muted" aria-hidden="true"></i>
                <h3 class="h5 mt-3">No Completed Rides</h3>
                <p class="text-muted">Your completed rides will appear here</p>
            </div>
            {% endif %}
        </div>

        <!-- Cancelled Bookings Tab -->
        <div class="tab-pane fade" id="cancelled" role="tabpanel">
            {% set cancelled_bookings = past_bookings|selectattr('status', 'in', ['CANCELLED', 'REJECTED'])|list %}
            {% if cancelled_bookings %}
            <div class="list-group">
                {% for booking in cancelled_bookings %}
                <div class="list-group-item list-group-item-action p-0 mb-2 border rounded opacity-75">
                    <!-- Collapsed Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer"
                        data-bs-toggle="collapse" data-bs-target="#cancelled-booking-{{ booking.id }}"
                        aria-expanded="false" role="button">
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center text-muted" style="min-width: 50px;">
                                <div class="small">{{ booking.ride.start_date.strftime('%b') }}</div>
                                <div class="fs-5">{{ booking.ride.start_date.strftime('%d') }}</div>
                            </div>
                            <div>
                                <div class="text-muted">{{ booking.ride.origin }} → {{ booking.ride.destination }}</div>
                                <small class="text-muted">
                                    <i class="bi bi-person me-1" aria-hidden="true"></i>{{ booking.ride.driver.username
                                    }}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-{{ 'secondary' if booking.status == 'REJECTED' else 'danger' }}">
                                {{ booking.status }}
                            </span>
                            <i class="bi bi-chevron-down" aria-hidden="true"></i>
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    <div class="collapse border-top" id="cancelled-booking-{{ booking.id }}">
                        <div class="p-3 bg-light">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Scheduled Date</small>
                                    <span>{{ booking.ride.start_date.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Seats Requested</small>
                                    <span>{{ booking.seats }}</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Would Have Cost</small>
                                    <span>₹{{ "%.2f"|format(booking.seats * booking.ride.price_per_seat) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle display-4 text-success" aria-hidden="true"></i>
                <h3 class="h5 mt-3">No Cancelled Bookings</h3>
                <p class="text-muted">You haven't cancelled any bookings</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .cursor-pointer:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    [data-bs-toggle="collapse"] .bi-chevron-down {
        transition: transform 0.2s ease;
    }

    [data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
    }
</style>

<script>
    function cancelBooking(bookingId) {
        if (confirm('Are you sure you want to cancel this booking?')) {
            fetch('/cancel-booking/' + bookingId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => response.ok && location.reload());
        }
    }
</script>
{% endblock %}